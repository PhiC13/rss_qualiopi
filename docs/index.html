<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Veille Le Bateau Jaune ‚Äì Philippe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/style.css">
</head>

<body>

<header>
    <img src="img/Logo_LBJ-13A.png" alt="Logo Le Bateau Jaune" class="logo">
    <div class="title-block">
        <h1>Veille r√©glementaire, p√©dagogique et m√©tiers</h1>
        <p>Agr√©gateur</p>
    </div>
</header>

<nav class="top-menu">
    <a href="index.html">Accueil</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="xml/logs.jsonl" target="_blank">Logs</a>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Rechercher dans tous les articles‚Ä¶">
    </div>

    <!-- BADGE PIPELINE -->
    <span id="pipeline-status" class="pipeline-badge">Chargement‚Ä¶</span>
</nav>

<div class="layout">

    <!-- COLONNE GAUCHE -->
    <div class="main-column">

        <!-- Veille l√©gale -->
        <details class="section-block" open>
            <summary>Veille l√©gale & r√©glementaire</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_legal.xml" target="_blank">flux_legal.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="legal-service-public"></div>
            <div id="legal-travail"></div>
            <div id="legal-economie"></div>

            <!-- Flux consolid√© -->
            <div id="articles-legal"></div>
        </details>

        <!-- Veille p√©dagogique -->
        <details class="section-block">
            <summary>Veille p√©dagogique & technologique</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_pedago.xml" target="_blank">flux_pedago.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="pedago-digiforma"></div>

            <!-- Flux consolid√© -->
            <div id="articles-pedago"></div>
        </details>

        <!-- Veille m√©tiers -->
        <details class="section-block">
            <summary>√âvolution m√©tiers & comp√©tences (Sport / Plong√©e)</summary>

            <div class="flux-consolidated">
                <a href="xml/flux_metiers.xml" target="_blank">flux_metiers.xml</a>
            </div>

            <!-- SOURCES EXTERNES -->
            <div id="metiers-injep"></div>
            <div id="metiers-ffessm"></div>

            <!-- Flux consolid√© -->
            <div id="articles-metiers"></div>
        </details>

    </div>

    <!-- COLONNE DROITE -->
    <aside class="sidebar">

        <h3>Activit√© r√©cente</h3>
        <canvas id="activityChart" width="300" height="200"></canvas>

        <!-- STATUT PIPELINE -->
        <h3>Mises √† jour</h3>
        <div id="pipeline-status-box"></div>

        <!-- MINI LOG -->
        <h3>Historique des mises √† jour</h3>
        <div id="update-history"></div>
        <a href="xml/update_history.log" target="_blank">Voir le log complet</a>

        <h3>Derniers articles (toutes rubriques)</h3>
        <div id="articles-global"></div>
    </aside>

</div>

<footer>
    Agr√©gateur RSS ‚Äì Philippe ‚Äì Propuls√© par Python & o2switch
</footer>

<!-- Scripts dans le bon ordre -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="assets/js/feeds-local.js"></script>
<script src="assets/js/feeds-external.js"></script>
<script src="assets/js/activity-chart.js"></script>
<script src="assets/js/main.js"></script>

<!-- SCRIPT PIPELINE + MINI LOG -->
<script>
/* --- BADGE TOP-MENU + STATUT PIPELINE --- */
fetch("xml/last_update.json")
  .then(r => r.json())
  .then(data => {
    const date = new Date(data.last_update);
    const formatted = date.toLocaleString("fr-FR");

    // Badge top-menu
    const badge = document.getElementById("pipeline-status");
    badge.textContent = "üü¢ Mise √† jour : " + formatted;
    badge.classList.add("pipeline-ok");

    // Encadr√© sidebar
    document.getElementById("pipeline-status-box").innerHTML =
      `<div class="pipeline-ok-box">
         üü¢ Mise √† jour OK<br>
         Derni√®re mise √† jour : <strong>${formatted}</strong>
       </div>`;
  })
  .catch(() => {
    const badge = document.getElementById("pipeline-status");
    badge.textContent = "üî¥ Echec de la mise √† jour";
    badge.classList.add("pipeline-ko");

    document.getElementById("pipeline-status-box").innerHTML =
      `<div class="pipeline-ko-box">
         üî¥ Echec de la mise √† jour<br>
         Impossible de lire last_update.json
       </div>`;
  });

/* --- MINI LOG DES MISES √Ä JOUR --- */
fetch("xml/update_history.log")
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n").slice(-5).reverse();
    document.getElementById("update-history").innerHTML =
      "<ul>" + lines.map(l => `<li>${l}</li>`).join("") + "</ul>";
  })
  .catch(() => {
    document.getElementById("update-history").innerHTML =
      "<em>Historique indisponible</em>";
  });
</script>

</body>
</html>